---
uuid: 9ba4ea40-6096-11ec-8aec-5da075fe55e4
title: 事件循环
date: 2021-12-19 14:40:51
tags:
---

### [Event Loop](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model)

#### [浏览器](https://cloud.tencent.com/developer/article/1533889)

在浏览器端关于事件循环有两个概念：一个是 Macro Task 也称作 Task Queue，一个是 Micro Task。

Macrotasks 包含了解析 HTML、生成 DOM、执行主线程 JS 代码和其他事件如 页面加载、输入、网络事件、定时器事件等。从浏览器的角度，Macrotask 代表的是一些离散的独立的工作。

常见应用
setTimeout, setInterval, setImmediate, requestAnimationFrame, I/O, UI rendering

Microtasks 则是为了完成一些更新应用程序状态的较小的任务，如处理 Promise 的回调和 DOM 的修改，以便让这些任务在浏览器重新渲染之前执行。Microtask 应该以异步的方式尽快执行，所以它们的开销比 Macrotask 要小，并且可以使我们在 UI 重新渲染之前执行，避免了不必要的 UI 渲染。

常见应用
process.nextTick, Promises, Object.observe, MutationObserver

[code show](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)

```js
console.log('script start');
setTimeout(function () {
  console.log('setTimeout');
}, 0);
Promise.resolve()
  .then(function () {
    console.log('promise1');
  })
  .then(function () {
    console.log('promise2');
  });
console.log('script end');

// script start
// script end
// promise1
// promise2
// setTimeout
```

try it

```js
console.log('start')
setTimeout(function () {
  console.log('setTimeout')
}, 0)
Promise.resolve().then(()=>{console.log('promise1')}).then(()=>{console.log('promise2')})
const timer = setInterval(function () {
  console.log('setInterval')
  Promise.resolve().then(console.log('promise 5'))
  clearInterval(timer)
}, 0)
Promise.resolve().then(()=>{console.log('promise3')}).then(()=>{console.log('promise4')})
console.log('end')
// start
// end
// promise1
// promise3
// promise2
// promise4
// setTimeout
// setInterval
// promise 5
```

#### Node

┌───────────────────────────┐
┌─>│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │&lt;─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘

![](./imgs/node-loop.awebp)

┌───────────────────────────┐
┌─>│           timers          │
│  └─────────────┬─────────────┘
│           nextTickQueue
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│           nextTickQueue
│  ┌─────────────┴─────────────┐
|  |     idle, prepare         │
|  └─────────────┬─────────────┘
nextTickQueue     nextTickQueue
|  ┌─────────────┴─────────────┐
|  │           poll            │
│  └─────────────┬─────────────┘
│           nextTickQueue
│  ┌─────────────┴─────────────┐
│  │           check           │
│  └─────────────┬─────────────┘
│           nextTickQueue
│  ┌─────────────┴─────────────┐
└──┤       close callbacks     │
└───────────────────────────┘

```js
console.log('start')
setTimeout(function () {
  console.log('setTimeout')
}, 0)
setImmediate(()=>{console.log('setImmediate')})
Promise.resolve().then(()=>{console.log('promise1')}).then(()=>{console.log('promise2')})
const timer = setInterval(function () {
  console.log('setInterval')
  Promise.resolve().then(console.log('promise5'))
  clearInterval(timer)
}, 0)
process.nextTick(()=>{console.log('nextTick')})
Promise.resolve().then(()=>{console.log('promise3')}).then(()=>{console.log('promise4')})
console.log('end')

// start
// end
// promise1
// promise3
// promise2
// promise4
// setImmediate 比 setTimeout 早
// setTimeout
// setInterval
// promise5
```
